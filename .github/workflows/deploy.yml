name: Deploy to Cloud Run

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ghost-engine-labs
  GCP_REGION: us-central1
  CLOUD_RUN_SERVICE: orchestrator
  ARTIFACT_REPO: orchestrator
  WORKLOAD_IDENTITY_PROVIDER: projects/22897403143/locations/global/workloadIdentityPools/github-pool/providers/github-oidc
  AUDIENCE: https://iam.googleapis.com/projects/22897403143/locations/global/workloadIdentityPools/github-pool/providers/github-oidc

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write
    concurrency:
      group: deploy-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: gh-actions-deployer@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com
          audience: ${{ env.AUDIENCE }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Artifact Registry Docker auth
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Compute image tag
        id: meta
        run: |
          echo "sha=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          echo "image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.CLOUD_RUN_SERVICE }}:${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build image (orchestrator)
        working-directory: services/orchestrator
        run: |
          set -euxo pipefail
          docker build -t "${{ steps.meta.outputs.image }}" .

      - name: Local container smoke test (pre-deploy)
        run: |
          set -euxo pipefail
          docker run -d --name smoke -e PORT=8080 -p 8080:8080 "${{ steps.meta.outputs.image }}"
          # Wait up to ~40s for /health=200
          for i in {1..20}; do
            sleep 2
            code="$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:8080/health || true)"
            if [ "$code" = "200" ]; then
              echo "Local health check passed"
              break
            fi
            if [ $i -eq 20 ]; then
              echo "::error::Local container failed to start; dumping logs"
              docker logs smoke || true
              docker rm -f smoke || true
              exit 1
            fi
          done
          docker rm -f smoke

      - name: Push image
        run: docker push "${{ steps.meta.outputs.image }}"

      - name: Deploy to Cloud Run (orchestrator)
        run: |
          set -euxo pipefail
          gcloud run deploy "${{ env.CLOUD_RUN_SERVICE }}" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --region "${{ env.GCP_REGION }}" \
            --image "${{ steps.meta.outputs.image }}" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --cpu 1 \
            --memory 256Mi \
            --min-instances 0 \
            --max-instances 2 \
            --timeout 600 \
            --set-env-vars PORT=8080,AGENT_MODE=off

      - name: Get Service URL
        id: url
        run: |
          gcloud run services describe "${{ env.CLOUD_RUN_SERVICE }}" \
            --region "${{ env.GCP_REGION }}" \
            --format='value(status.url)' | tee service_url.txt
          echo "url=$(cat service_url.txt)" >> "$GITHUB_OUTPUT"

      - name: Remote smoke test
        run: |
          set -euxo pipefail
          URL="${{ steps.url.outputs.url }}"
          echo "Service URL: $URL"
          ROOT_CODE="$(curl -s -o /dev/null -w '%{http_code}' "$URL/")"
          HEALTH_CODE="$(curl -s -o /dev/null -w '%{http_code}' "$URL/health")"
          echo "$ROOT_CODE" > root_status.txt
          echo "$HEALTH_CODE" > health_status.txt
          test "$HEALTH_CODE" = "200"

      - name: Upload URL & status artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloud-run-smoke
          path: |
            service_url.txt
            root_status.txt
            health_status.txt
          if-no-files-found: error

      - name: Show recent logs on failure
        if: failure()
        run: |
          gcloud run services logs read "${{ env.CLOUD_RUN_SERVICE }}" \
            --region "${{ env.GCP_REGION }}" --limit=200 || true
