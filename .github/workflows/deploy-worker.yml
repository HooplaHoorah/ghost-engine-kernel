name: Deploy Worker
on: { workflow_dispatch: {} }
permissions: { id-token: write, contents: read }

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auth to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/22097403143/locations/global/workloadIdentityPools/github-pool/providers/github-oidc
          audience: https://iam.googleapis.com/projects/22097403143/locations/global/workloadIdentityPools/github-pool/providers/github-oidc
          service_account: ${{ vars.DEPLOYER_SA }}

      - uses: google-github-actions/setup-gcloud@v2
        with: { project_id: ghost-engine-labs }

      - name: Build & push (worker)
        run: |
          set -euo pipefail
          IMAGE="us-central1-docker.pkg.dev/ghost-engine-labs/orchestrator/worker:${GITHUB_SHA}"
          gcloud builds submit services/worker --tag "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy to Cloud Run (worker)
        run: |
          set -euo pipefail
          gcloud run deploy worker \
            --region us-central1 \
            --image "$IMAGE" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080

      - name: Smoke test
        run: |
          URL="$(gcloud run services describe worker --region us-central1 --format='value(status.url)')"
          CODE="$(curl -s -o /dev/null -w '%{http_code}' "$URL/health")"
          echo "Service URL: $URL" >> $GITHUB_STEP_SUMMARY
          echo "GET /health â†’ $CODE" >> $GITHUB_STEP_SUMMARY
