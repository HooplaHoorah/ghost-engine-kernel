name: Deploy Worker to Cloud Run
run-name: Deploy Worker to Cloud Run â€” ${{ github.ref_name }} by ${{ github.actor }}

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "services/worker/**"
      - "Dockerfile"
      - "package.json"
      - ".github/workflows/deploy-worker.yml"

env:
  PROJECT_ID: ghost-engine-labs
  REGION: us-central1
  SERVICE: worker
  REPO: ghost-engine
  IMAGE: us-central1-docker.pkg.dev/ghost-engine-labs/ghost-engine/worker

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/22097043143/locations/global/workloadIdentityPools/github-pool/providers/github-oidc'
          service_account: 'gh-actions-deployer@ghost-engine-labs.iam.gserviceaccount.com'
          audience: '//iam.googleapis.com/projects/22097043143/locations/global/workloadIdentityPools/github-pool/providers/github-oidc'

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Artifact Registry docker auth
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & tag
        working-directory: services/worker
        run: |
          docker build -t "$IMAGE:github-${GITHUB_SHA}" -t "$IMAGE:latest" ../../

      - name: Push
        run: |
          docker push "$IMAGE:github-${GITHUB_SHA}"
          docker push "$IMAGE:latest"

      - name: Deploy to Cloud Run (as a service)
        id: deploy
        run: |
          gcloud run deploy "$SERVICE" \
            --image "$IMAGE:github-${GITHUB_SHA}" \
            --region "$REGION" \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --max-instances 3 \
            --quiet
          URL="$(gcloud run services describe "$SERVICE" --region "$REGION" --format='value(status.url)')"
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Smoke: /health CORS header
        run: |
          curl -sI -H "Origin: https://example.com" "${{ steps.deploy.outputs.url }}/health" | grep -i 'access-control-allow-origin'
